#!/bin/bash
# VaseOS Internal Dependencies Documentation
# This file documents all tools used internally by Vase components
# Use this to verify the vasebuild profile has everything needed
SCRIPT_DIR="$(dirname "$0")"
. "$SCRIPT_DIR/../util_f"
. "$SCRIPT_DIR/../..."

# Source rcw for info/warn/reop functions
if [ -f "$SCRIPT_DIR/../.vase.d/rcw" ]; then
    . "$SCRIPT_DIR/../.vase.d/rcw"
fi

MISSING=()
# Core packages required for Klartix installations
# These are needed on the HOST system to run the Klartix installer
PACKAGES="git archiso gnupg squashfs-tools jq tree wget parted lvm2 cryptsetup"

# Filesystem tools (optional based on TARGET_FS in klartix.conf)
# Add these if using non-ext4 filesystems:
# - btrfs-progs (for btrfs)
# - xfsprogs (for xfs)
# - f2fs-tools (for f2fs)

preop "Checking BUILD and INSTALL packages..."
for pkg in $PACKAGES; do
    if ! to_devnull pacman -Qi "$pkg"; then
        postop "Missing: $pkg"
        MISSING+=("$pkg")
    else
        version=$(pacman -Qi "$pkg" 2>/dev/null | grep "^Version" | awk '{print $3}')
        preop "Found: $pkg ($version)"
    fi
done

if [ ${#MISSING[@]} -gt 0 ]; then
    echo ""
    info "Missing packages: ${MISSING[*]}"
    info "Install with: sudo pacman -S ${MISSING[*]}"
    exit 1
else
    echo ""
    info "All dependencies satisfied!"
    exit 0
fi

# Categories:
# [BUILD] - ISO creation (iso_mod) 
# [VM] - VM testing (has it's own dep check ./zazu_lago/setup_vms and env)
# [INSTALL] - Installer runtime Host-2-Target installs (hade_box/install, altodeps)
# [CORE] - Core system dependencies

# Build-time Dependencies (ISO Creation)
# ========================================
# [BUILD] archiso                    - Base ISO building framework
# [BUILD] pacman                     - Package manager (download/install)
# [BUILD] repo-add                   - Create local package repositories
# [BUILD] git                        - Version control, file filtering (ls-files)
# [BUILD] gpg                        - ISO signing
# [BUILD] tar                        - Archive creation for airootfs
# [BUILD] sed, awk, grep             - Text processing for configs
# [BUILD] squashfs-tools             - ISO compression (via mkarchiso)
# [UTIL] jq                          - JSON parsing 
# [UTIL] curl, wget                  - HTTP requests (GitHub API)
# [UTIL] tree                        - Directory structure output (optional)
# [UTIL] du, find, wc                - Disk/file statistics
# [UTIL] date                        - Timestamps, timing

# Core Dependencies (Always Required)
# ========================================
# [CORE] bash                        - Shell (all scripts)
# [CORE] coreutils                   - cat, ls, cp, mv, rm, etc
# [CORE] findutils                   - find, xargs
# [CORE] sed                         - Stream editor
# [CORE] gawk                        - GNU awk
# [CORE] grep                        - Pattern matching
# [CORE] util-linux                  - Basic system utilities
